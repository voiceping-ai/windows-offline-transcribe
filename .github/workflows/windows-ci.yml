name: Windows CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build-windows-app:
    name: Build WinUI App (x64)
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build WinUI app
        run: >
          msbuild src/OfflineTranscription/OfflineTranscription.csproj
          /restore
          /p:Configuration=Release
          /p:Platform=x64
          /p:ContinuousIntegrationBuild=true
          /m

  test-core:
    name: Run Core Tests
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore tests
        run: dotnet restore tests/OfflineTranscription.Tests/OfflineTranscription.Tests.csproj

      - name: Build tests
        run: >
          dotnet build tests/OfflineTranscription.Tests/OfflineTranscription.Tests.csproj
          -c Release
          -p:Platform=x64
          --no-restore

      - name: Run tests
        run: >
          dotnet test tests/OfflineTranscription.Tests/OfflineTranscription.Tests.csproj
          -c Release
          -p:Platform=x64
          --no-build
          --verbosity normal
          --logger "trx;LogFileName=test-results.trx"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-test-results
          path: "**/*.trx"

  package-installer:
    name: Package App + Installer (x64)
    runs-on: windows-2022
    needs:
      - build-windows-app
      - test-core

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Download whisper.cpp DLLs
        shell: cmd
        run: |
          if not exist libs\runtimes\win-x64 mkdir libs\runtimes\win-x64
          echo Downloading whisper.cpp...
          curl.exe -fsSL --retry 3 -o "%RUNNER_TEMP%\whisper.zip" "https://github.com/ggml-org/whisper.cpp/releases/download/v1.8.3/whisper-bin-x64.zip"
          echo Extracting...
          mkdir "%RUNNER_TEMP%\whisper" 2>NUL
          tar -xf "%RUNNER_TEMP%\whisper.zip" -C "%RUNNER_TEMP%\whisper"
          echo Copying DLLs...
          for %%f in (whisper.dll ggml.dll ggml-base.dll ggml-cpu.dll) do (
            for /R "%RUNNER_TEMP%\whisper" %%g in (%%f) do copy /Y "%%g" "libs\runtimes\win-x64\%%f"
          )
          dir libs\runtimes\win-x64\*.dll

      - name: Download sherpa-onnx DLLs
        shell: cmd
        run: |
          echo Downloading sherpa-onnx...
          curl.exe -fsSL --retry 3 -o "%RUNNER_TEMP%\sherpa.tar.bz2" "https://github.com/k2-fsa/sherpa-onnx/releases/download/v1.12.25/sherpa-onnx-v1.12.25-win-x64-shared-MD-Release.tar.bz2"
          echo Download complete. Extracting with 7-Zip...
          "C:\Program Files\7-Zip\7z.exe" x "%RUNNER_TEMP%\sherpa.tar.bz2" -o"%RUNNER_TEMP%" -y
          "C:\Program Files\7-Zip\7z.exe" x "%RUNNER_TEMP%\sherpa.tar" -o"%RUNNER_TEMP%\sherpa" -y
          echo Copying DLLs...
          for %%f in (sherpa-onnx-c-api.dll onnxruntime.dll onnxruntime_providers_shared.dll) do (
            for /R "%RUNNER_TEMP%\sherpa" %%g in (%%f) do copy /Y "%%g" "libs\runtimes\win-x64\%%f"
          )
          dir libs\runtimes\win-x64\*.dll

      - name: Download translation DLLs
        shell: pwsh
        run: |
          Write-Host "Downloading translation native DLLs..."
          $zipPath = Join-Path $env:RUNNER_TEMP 'translation.zip'
          $url = "https://github.com/voiceping-ai/windows-offline-transcribe/releases/download/translation-native-v1/translation-native-win-x64.zip"
          try {
            Invoke-WebRequest -Uri $url -OutFile $zipPath -UseBasicParsing -ErrorAction Stop
            Write-Host "Extracting..."
            tar -xf $zipPath -C "libs\runtimes\win-x64"
            Write-Host "Translation DLLs extracted."
          } catch {
            Write-Host "::warning::Translation DLLs not available yet (release translation-native-v1 not found). Skipping."
          }
          Get-ChildItem libs\runtimes\win-x64\*.dll | Format-Table Name, Length

      - name: Publish WinUI app
        shell: pwsh
        run: |
          $publishDir = Join-Path $PWD 'artifacts\publish\win-x64'
          New-Item -ItemType Directory -Force -Path $publishDir | Out-Null

          msbuild src/OfflineTranscription/OfflineTranscription.csproj `
            /restore `
            /t:Publish `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:RuntimeIdentifier=win-x64 `
            /p:SelfContained=true `
            /p:WindowsPackageType=None `
            /p:PublishDir="$publishDir\" `
            /p:ContinuousIntegrationBuild=true `
            /p:GeneratePriFilesOnBuild=true `
            /m

          if (-not (Test-Path (Join-Path $publishDir 'OfflineTranscription.exe'))) {
            throw "Expected published executable not found in $publishDir"
          }

          # Ensure PRI resource file is in publish output (required for WinUI XAML)
          $buildDir = Join-Path $PWD 'src\OfflineTranscription\bin\x64\Release\net8.0-windows10.0.19041.0\win-x64'
          $priFile = Join-Path $publishDir 'OfflineTranscription.pri'
          if (-not (Test-Path $priFile)) {
            $srcPri = Join-Path $buildDir 'OfflineTranscription.pri'
            if (Test-Path $srcPri) {
              Copy-Item $srcPri $priFile
              Write-Host "Copied OfflineTranscription.pri from build output"
            } else {
              throw "OfflineTranscription.pri not found in build or publish output"
            }
          }

      - name: Create portable zip
        shell: pwsh
        run: |
          $publishDir = Join-Path $PWD 'artifacts\publish\win-x64'
          $zipDir = Join-Path $PWD 'artifacts\portable'
          New-Item -ItemType Directory -Force -Path $zipDir | Out-Null

          $zipPath = Join-Path $zipDir 'OfflineTranscription-win-x64-portable.zip'
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }

          Compress-Archive -Path (Join-Path $publishDir '*') -DestinationPath $zipPath -Force

      - name: Install Inno Setup
        run: choco install innosetup -y --no-progress

      - name: Build installer
        shell: pwsh
        run: |
          $publishDir = Join-Path $PWD 'artifacts\publish\win-x64'
          $installerDir = Join-Path $PWD 'artifacts\installer'
          $appVersion = "1.0.$env:GITHUB_RUN_NUMBER"
          New-Item -ItemType Directory -Force -Path $installerDir | Out-Null

          $iscc = Join-Path ${env:ProgramFiles(x86)} 'Inno Setup 6\ISCC.exe'
          if (-not (Test-Path $iscc)) {
            throw "ISCC.exe not found at $iscc"
          }

          & $iscc "installer\OfflineTranscription.iss" `
            "/DSourceDir=$publishDir" `
            "/DOutputDir=$installerDir" `
            "/DOutputBaseName=OfflineTranscription-win-x64-setup" `
            "/DAppVersion=$appVersion"

          if (-not (Test-Path (Join-Path $installerDir 'OfflineTranscription-win-x64-setup.exe'))) {
            throw "Installer output not found in $installerDir"
          }

      - name: Validate packaged binaries
        shell: pwsh
        run: |
          $portable = Join-Path $PWD 'artifacts\portable\OfflineTranscription-win-x64-portable.zip'
          $installer = Join-Path $PWD 'artifacts\installer\OfflineTranscription-win-x64-setup.exe'

          if (-not (Test-Path $portable)) {
            throw "Portable zip missing: $portable"
          }
          if (-not (Test-Path $installer)) {
            throw "Installer missing: $installer"
          }
          if ((Get-Item $portable).Length -lt 1MB) {
            throw "Portable zip is unexpectedly small"
          }
          if ((Get-Item $installer).Length -lt 1MB) {
            throw "Installer is unexpectedly small"
          }

          $verifyDir = Join-Path $env:RUNNER_TEMP 'portable-verify'
          if (Test-Path $verifyDir) {
            Remove-Item -Recurse -Force $verifyDir
          }
          Expand-Archive -Path $portable -DestinationPath $verifyDir -Force
          if (-not (Test-Path (Join-Path $verifyDir 'OfflineTranscription.exe'))) {
            throw "Portable zip does not contain OfflineTranscription.exe"
          }
          if (-not (Test-Path (Join-Path $verifyDir 'OfflineTranscription.pri'))) {
            throw "Portable zip does not contain OfflineTranscription.pri (WinUI XAML resources)"
          }

          # Verify native inference DLLs are present
          $requiredDlls = @(
            'whisper.dll',
            'ggml.dll',
            'ggml-base.dll',
            'ggml-cpu.dll',
            'sherpa-onnx-c-api.dll',
            'onnxruntime.dll',
            'onnxruntime_providers_shared.dll'
          )
          foreach ($dll in $requiredDlls) {
            if (-not (Test-Path (Join-Path $verifyDir $dll))) {
              throw "Portable zip missing native DLL: $dll"
            }
          }

          # Translation DLLs are optional until the release is published
          $translationDlls = @(
            'OfflineTranscription.NativeTranslation.dll',
            'libctranslate2.dll',
            'libstdc++-6.dll',
            'libgomp-1.dll'
          )
          $translationPresent = $true
          foreach ($dll in $translationDlls) {
            if (-not (Test-Path (Join-Path $verifyDir $dll))) {
              Write-Host "::warning::Translation DLL not packaged: $dll"
              $translationPresent = $false
            }
          }
          if ($translationPresent) {
            Write-Host "All translation DLLs present."
          } else {
            Write-Host "::warning::Translation DLLs missing - translation feature will not be available in this build."
          }

          $checksumFile = Join-Path $PWD 'artifacts\checksums\windows-binaries.sha256'
          New-Item -ItemType Directory -Force -Path (Split-Path $checksumFile -Parent) | Out-Null
          @(
            (Get-FileHash $portable -Algorithm SHA256).Hash.ToLower() + "  OfflineTranscription-win-x64-portable.zip"
            (Get-FileHash $installer -Algorithm SHA256).Hash.ToLower() + "  OfflineTranscription-win-x64-setup.exe"
          ) | Set-Content -Path $checksumFile -Encoding ascii

      - name: Upload portable zip
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable-win-x64
          path: artifacts/portable/OfflineTranscription-win-x64-portable.zip

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-win-x64
          path: artifacts/installer/OfflineTranscription-win-x64-setup.exe

      - name: Upload checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries-checksums
          path: artifacts/checksums/windows-binaries.sha256

      - name: Publish GitHub release assets
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.sha }}
          name: Build ${{ github.sha }}
          prerelease: true
          generate_release_notes: true
          files: |
            artifacts/portable/OfflineTranscription-win-x64-portable.zip
            artifacts/installer/OfflineTranscription-win-x64-setup.exe
            artifacts/checksums/windows-binaries.sha256
          fail_on_unmatched_files: true
          overwrite_files: true
